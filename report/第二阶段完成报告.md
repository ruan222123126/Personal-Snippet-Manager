# 第二阶段完成报告：业务逻辑与 API 实现

**日期**: 2026-01-23
**任务**: 第二阶段 - 服务层与 API 实现
**状态**: ✅ 已完成

---

## 概述

成功为 Personal Snippet Manager 注入了"大脑"和"灵魂"：
- 增强了 Shiki 代码高亮服务
- 实现了完整的 snippets API，包括 GET（搜索/标签/默认列表）和 POST（事务写入）
- 修复了 FTS5 集成问题和 SQLite 配置
- 所有 TypeScript 类型检查通过

---

## 完成的工作

### 1. 增强 Shiki 服务 (`lib/shiki.ts`)

**修改内容**：
- 更新导入以使用 `createHighlighter`（Shiki 3.x API）
- 添加 `highlightCode` 函数：
  - 接收 `code` 和 `language` 参数
  - 当语言不支持时回退到 `text` 语言
  - 返回支持亮色/暗色主题的 HTML 字符串

**文件**: `lib/shiki.ts`

### 2. 实现 Snippets API (`app/api/snippets/route.ts`)

**GET 方法** - 三种查询模式：
1. **FTS 全文搜索** (`?q=query`)：使用 SQLite FTS5 并正确连接 rowid
2. **标签过滤** (`?tag=name`)：按标签名称过滤 snippets
3. **默认列表**：返回最新的 20 条 snippets

**POST 方法** - 事务写入：
- 验证必填字段（title、code、language）
- 使用 `prisma.$transaction` 保证原子性
- 实现标签 `upsert` 避免重复
- 创建 Snippet、Tags 和 TagOnSnippet 关联表记录

### 3. 修复配置问题

**next.config.js**：
- 重命名为 `next.config.mjs` 以兼容 ES 模块
- 更新为使用 ES 模块语法

**prisma.config.ts**：
- 修复了 DATABASE_URL 未定义的类型错误

### 4. 修复 FTS5 迁移

**问题**：原始迁移使用 `new.id`（TEXT）作为 FTS 的 rowid 列，导致"datatype mismatch"错误

**解决方案** (`prisma/migrations/20260123114143_init/migration.sql`)：
- 将触发器改为使用 `new.rowid` 而不是 `new.id`
- SQLite 会自动为没有 INTEGER PRIMARY KEY 的表创建 rowid
- 更新 API 通过 rowid 连接 Snippet 和 SnippetFTS

---

## 验证结果

### 测试 1：POST - 创建带标签的 Snippet
```bash
curl -X POST http://localhost:3001/api/snippets \
  -H "Content-Type: application/json" \
  -d '{
    "title": "React useEffect Example",
    "description": "A simple useEffect hook example",
    "code": "useEffect(() => { ... });",
    "language": "typescript",
    "tags": ["React", "Hooks", "Next.js"]
  }'
```
**结果**: ✅ 成功 - 创建了包含 3 个标签的 snippet

### 测试 2：GET - 默认列表
```bash
curl http://localhost:3001/api/snippets
```
**结果**: ✅ 成功 - 返回 snippets 数组

### 测试 3：GET - FTS 搜索
```bash
curl "http://localhost:3001/api/snippets?q=React"
```
**结果**: ✅ 成功 - 返回匹配的 snippets

### 测试 4：GET - 标签过滤
```bash
curl "http://localhost:3001/api/snippets?tag=React"
```
**结果**: ✅ 成功 - 返回带有 "React" 标签的 snippets

---

## 验证检查

✅ TypeScript 类型检查通过：`npx tsc --noEmit`
✅ 所有 API 端点已通过 curl 测试
✅ 数据库事务正常工作
✅ FTS5 触发器正确同步 SnippetFTS 表

---

## 修改/创建的文件

1. `lib/shiki.ts` - 添加 `highlightCode` 函数
2. `app/api/snippets/route.ts` - 实现 GET 和 POST 处理器
3. `next.config.mjs` - 新建（从 .js 重命名）
4. `prisma.config.ts` - 修复类型错误
5. `prisma/migrations/20260123114143_init/migration.sql` - 修复 FTS5 触发器

---

## 遇到的问题与解决方案

### 问题 1：创建 snippet 时出现 "datatype mismatch" 错误
**原因**：FTS 触发器使用 TEXT 类型的 id 作为 rowid 列
**解决方法**：更新触发器使用 `new.rowid` 替代 `new.id`

### 问题 2："attempt to write a readonly database" 错误
**原因**：多个进程访问数据库，文件权限问题
**解决方法**：终止所有 node/prisma 进程，清理 journal 文件，修复权限

### 问题 3：FTS 搜索中出现 "no such column: id" 错误
**原因**：SnippetFTS 使用 rowid 而不是 id 列
**解决方法**：更新查询通过 rowid JOIN Snippet 和 SnippetFTS

---

## 下一步

第三阶段可能涉及：
- 构建前端 UI 组件
- 集成 highlightCode 函数
- 创建 snippet 列表和详情视图
- 实现 snippet 创建表单

---

**第二阶段状态**: ✅ 已完成并验证
