# 搜索增强功能任务

## 任务概述

当前的搜索功能仅支持基础的全文搜索（FTS5），本任务旨在增强搜索体验，添加模糊搜索、分类搜索、高级筛选、搜索历史等功能。

---

## 任务目标

1. **模糊搜索**：支持拼音搜索、模糊匹配
2. **分类搜索**：按语言、标签、时间范围筛选
3. **高级搜索**：组合多个条件
4. **搜索历史**：保存和快速访问历史搜索
5. **搜索建议**：实时搜索建议和自动补全
6. **搜索结果高亮**：关键词高亮显示

---

## 功能需求详细说明

### 1. 模糊搜索增强

**当前状态**：
- 使用 SQLite FTS5 全文搜索
- 分词器：`porter unicode61`（支持中文和英文）
- 搜索方式：精确匹配查询词

**需要增强**：
- [ ] **拼音搜索**：支持输入拼音搜索中文标题
- [ ] **模糊匹配**：支持部分关键词匹配（如 "react" 匹配 "reactjs"）
- [ ] **拼写容错**：支持常见拼写错误的自动纠正
- [ ] **同义词搜索**：支持同义词扩展（如 "js" 搜索包含 "javascript" 的结果）

**技术方案**：
```typescript
// lib/search.ts
export interface SearchOptions {
  query?: string;
  fuzzy?: boolean;      // 是否启用模糊匹配
  pinyin?: boolean;     // 是否启用拼音搜索
  tolerance?: number;   // 编辑距离容忍度
}

export async function enhancedSearch(options: SearchOptions) {
  // 1. 拼音转换（使用 pinyin-pro 或 similar）
  // 2. 模糊匹配算法（Levenshtein 距离）
  // 3. 结合 FTS5 搜索
}
```

---

### 2. 分类和筛选功能

**需求列表**：
- [ ] **语言筛选**：按编程语言过滤（JavaScript, Python, Go 等）
- [ ] **标签筛选**：按标签过滤（支持多选）
- [ ] **时间范围**：
  - 今天
  - 最近 7 天
  - 最近 30 天
  - 最近 3 个月
  - 自定义时间范围
- [ ] **代码长度**：短（< 50 行）、中（50-200 行）、长（> 200 行）
- [ ] **排序方式**：
  - 最新创建
  - 最近更新
  - 最相关（搜索时）
  - 最多使用（如果添加使用次数统计）

**UI 设计**：
```
┌─────────────────────────────────────────────────────────┐
│ 🔍 搜索框                                    [高级筛选] │
├─────────────────────────────────────────────────────────┤
│ 筛选条件：                                                │
│  语言: [全部▼] 标签: [全部▼] 时间: [全部时间▼]          │
│                                                         │
│ 排序: [最新创建▼]    [清除筛选]                         │
└─────────────────────────────────────────────────────────┘
```

**技术实现**：
```typescript
// lib/data.ts 扩展
export interface FilterOptions {
  languages?: string[];      // 语言列表
  tags?: string[];           // 标签列表
  dateRange?: {
    start: Date;
    end: Date;
  };
  codeLength?: 'short' | 'medium' | 'long';
  sortBy?: 'createdAt' | 'updatedAt' | 'relevance';
  sortOrder?: 'asc' | 'desc';
}

export async function getSnippetsWithFilters(
  query?: string,
  filters?: FilterOptions
): Promise<SnippetWithTags[]> {
  // 结合 FTS5 搜索和 Prisma 查询
  // 使用 WHERE 条件组合多个筛选器
}
```

---

### 3. 高级搜索面板

**功能需求**：
- [ ] **可折叠的高级筛选面板**
- [ ] **多条件组合**：AND / OR 逻辑
- [ ] **正则表达式搜索**：支持正则表达式匹配代码
- [ ] **字段特定搜索**：
  - `title:react` - 只搜索标题
  - `desc:hooks` - 只搜索描述
  - `code:useState` - 只搜索代码
  - `lang:typescript` - 搜索 TypeScript 代码

**搜索语法示例**：
```
# 组合搜索
react hooks lang:typescript

# 排除搜索
react -native

# 精确匹配
"useState hook"

# OR 搜索
react OR vue

# 字段特定
title:component desc:button
```

**UI 组件**：`components/AdvancedSearchPanel.tsx`
```tsx
interface AdvancedSearchPanelProps {
  onSearch: (query: SearchQuery) => void;
}

export function AdvancedSearchPanel({ onSearch }: AdvancedSearchPanelProps) {
  return (
    <Collapsible>
      <CollapsibleTrigger>高级筛选</CollapsibleTrigger>
      <CollapsibleContent>
        {/* 语言选择器 */}
        {/* 标签选择器 */}
        {/* 时间范围选择器 */}
        {/* 排序选项 */}
        {/* 搜索语法说明 */}
      </CollapsibleContent>
    </Collapsible>
  );
}
```

---

### 4. 搜索历史功能

**功能需求**：
- [ ] **保存搜索历史**（最多保存 20 条）
- [ ] **历史记录展示**：点击快速重新搜索
- [ ] **清除历史**：单条删除或全部清除
- [ ] **本地存储**：使用 localStorage 或数据库存储

**数据结构**：
```typescript
// lib/search-history.ts
export interface SearchHistoryItem {
  id: string;
  query: string;
  filters?: FilterOptions;
  timestamp: Date;
  resultCount: number;
}

export async function addSearchHistory(item: Omit<SearchHistoryItem, 'id' | 'timestamp'>);
export async function getSearchHistory(limit?: number): Promise<SearchHistoryItem[]>;
export async function clearSearchHistory();
export async function removeSearchHistoryItem(id: string);
```

**UI 设计**：
```
搜索框
├── 输入中...
└── 下拉建议
    ├── 🔍 历史搜索
    │   ├── react hooks          ✕
    │   ├── useState             ✕
    │   └── python asyncio       ✕
    ├── 📝 搜索建议
    │   ├── react hooks
    │   ├── react hooks useEffect
    │   └── react custom hooks
    └── 🔖 标签
        ├── react
        └── hooks
```

---

### 5. 搜索建议和自动补全

**功能需求**：
- [ ] **实时建议**：输入时显示搜索建议
- [ ] **自动补全**：Tab 键补全常见词
- [ ] **热门搜索**：显示最常搜索的关键词
- [ ] **智能建议**：基于历史搜索和当前输入

**数据来源**：
```typescript
// 搜索建议来源：
1. 标题中的关键词
2. 标签名称
3. 语言名称
4. 历史搜索记录
5. 热门搜索统计

// lib/search-suggestions.ts
export async function getSearchSuggestions(input: string): Promise<string[]> {
  const suggestions = [];

  // 1. 标签匹配
  const tags = await prisma.tag.findMany({
    where: { name: { contains: input } },
    take: 5,
  });
  suggestions.push(...tags.map(t => t.name));

  // 2. 标题关键词匹配
  // 3. 历史搜索匹配

  return suggestions;
}
```

**UI 组件**：`components/SearchSuggestions.tsx`
```tsx
export function SearchSuggestions() {
  const [suggestions, setSuggestions] = useState<string[]>([]);

  // 防抖处理
  // 键盘导航（上下箭头、Enter、ESC）
  // 点击选择
}
```

---

### 6. 搜索结果高亮

**功能需求**：
- [ ] **关键词高亮**：在标题、描述、代码中高亮搜索词
- [ ] **上下文预览**：显示关键词周围的代码片段
- [ ] **高亮样式**：使用明显的背景色标记

**实现方案**：
```typescript
// lib/highlight.ts
export function highlightText(
  text: string,
  query: string
): { html: string; matches: number } {
  // 1. 转义 HTML 特殊字符
  // 2. 使用正则表达式匹配关键词
  // 3. 包裹 <mark> 标签
  // 4. 返回高亮的 HTML 和匹配数量
}

// 使用示例
<p dangerouslySetInnerHTML={{ __html: highlightText(snippet.description, query).html }} />
```

**CSS 样式**：
```css
mark {
  background-color: #fde047;
  border-radius: 2px;
  padding: 0 2px;
}

.dark mark {
  background-color: #854d0e;
}
```

---

## 数据库扩展

### 新增表：搜索历史

```prisma
// prisma/schema.prisma

model SearchHistory {
  id          String   @id @default(cuid())
  userId      String?  // 预留：未来支持多用户
  query       String
  filters     String?  // JSON 格式存储筛选条件
  resultCount Int
  createdAt   DateTime @default(now())

  @@index([createdAt])
  @@index([query])
}

// 热门搜索统计（可选）
model SearchStats {
  id        String   @id @default(cuid())
  query     String   @unique
  searchCount Int    @default(0)
  lastSearchedAt DateTime @default(now())

  @@index([searchCount])
}
```

---

## API 设计

### 1. 搜索建议 API

**端点**：`GET /api/search/suggestions`

**查询参数**：
- `q`: 输入的关键词

**响应**：
```json
{
  "query": "react",
  "suggestions": [
    "react hooks",
    "react hooks useEffect",
    "react custom hooks",
    "react context",
    "react redux"
  ],
  "tags": ["react", "hooks", "javascript"],
  "languages": ["javascript", "typescript"]
}
```

### 2. 搜索历史 API

**端点**：
- `GET /api/search/history` - 获取搜索历史
- `POST /api/search/history` - 添加搜索历史
- `DELETE /api/search/history/:id` - 删除单条历史
- `DELETE /api/search/history` - 清空所有历史

### 3. 高级搜索 API

**端点**：`POST /api/search/advanced`

**请求体**：
```json
{
  "query": "react hooks",
  "filters": {
    "languages": ["javascript", "typescript"],
    "tags": ["react", "hooks"],
    "dateRange": {
      "start": "2024-01-01",
      "end": "2024-12-31"
    },
    "codeLength": "medium"
  },
  "sortBy": "relevance",
  "sortOrder": "desc",
  "page": 1,
  "limit": 20
}
```

**响应**：
```json
{
  "results": [...],
  "total": 42,
  "page": 1,
  "limit": 20,
  "hasMore": true
}
```

---

## 文件结构

```
app/
├── api/
│   └── search/
│       ├── suggestions/
│       │   └── route.ts           # 搜索建议 API
│       ├── history/
│       │   └── route.ts           # 搜索历史 API
│       └── advanced/
│           └── route.ts           # 高级搜索 API
├── search/
│   └── page.tsx                   # 搜索结果页（可选）

lib/
├── search.ts                      # 搜索核心逻辑
├── search-suggestions.ts          # 搜索建议
├── search-history.ts              # 搜索历史管理
└── fuzzy-search.ts                # 模糊搜索算法

components/
├── SearchBar.tsx                  # 搜索框组件
├── SearchSuggestions.tsx          # 搜索建议下拉
├── AdvancedSearchPanel.tsx        # 高级筛选面板
├── FilterChips.tsx                # 筛选标签显示
└── SearchHistory.tsx              # 搜索历史组件

prisma/
└── migrations/
    └── XXX_add_search_history.sql
```

---

## 实施计划

### 阶段一：基础筛选功能（优先级：高）
**预计时间**：2-3 小时

- [ ] 创建筛选 UI 组件
- [ ] 实现语言、标签筛选
- [ ] 实现时间范围筛选
- [ ] 实现排序功能
- [ ] 更新 API 支持筛选参数

### 阶段二：搜索历史和建议（优先级：中）
**预计时间**：2-3 小时

- [ ] 创建搜索历史表
- [ ] 实现搜索历史保存和读取
- [ ] 创建搜索历史 UI 组件
- [ ] 实现搜索建议 API
- [ ] 创建搜索建议下拉组件

### 阶段三：高级搜索功能（优先级：中）
**预计时间**：3-4 小时

- [ ] 实现高级搜索面板
- [ ] 支持搜索语法（字段特定、AND/OR 等）
- [ ] 实现正则表达式搜索
- [ ] 添加搜索语法说明和示例

### 阶段四：模糊搜索和增强（优先级：低）
**预计时间**：4-5 小时

- [ ] 集成拼音搜索库
- [ ] 实现模糊匹配算法
- [ ] 实现同义词扩展
- [ ] 性能优化和测试

### 阶段五：搜索结果高亮（优先级：中）
**预计时间**：1-2 小时

- [ ] 实现关键词高亮函数
- [ ] 在标题、描述中应用高亮
- [ ] 在代码预览中应用高亮
- [ ] 优化高亮样式

---

## UI/UX 设计要点

### 搜索框
- 宽度：100% 或固定宽度（如 600px）
- 占位符：显示搜索提示或示例
- 图标：搜索图标、清除图标
- 快捷键：`/` 或 `Ctrl+K` 聚焦搜索框

### 筛选标签
- 显示当前激活的筛选条件
- 可点击移除单个筛选
- "清除所有"按钮快速重置

### 搜索建议
- 键盘导航支持（上下箭头选择）
- 高亮匹配部分
- 显示搜索类型（历史/建议/标签）

### 高级面板
- 平滑展开/收起动画
- 清晰的分类标题
- 多选控件（复选框、标签选择器）

---

## 性能优化

### 1. 防抖处理
```typescript
// 搜索输入防抖
const debouncedSearch = useMemo(
  () => debounce((query: string) => {
    performSearch(query);
  }, 300),
  []
);
```

### 2. 缓存策略
- 缓存搜索结果（5 分钟）
- 缓存搜索建议（1 分钟）
- 使用 React Query 或 SWR

### 3. 数据库优化
- 为搜索字段添加索引
- 优化 FTS5 查询
- 分页加载结果

### 4. 虚拟滚动
- 大量搜索结果时使用虚拟滚动
- 懒加载代码高亮

---

## 测试计划

- [ ] 基础搜索功能测试
- [ ] 筛选功能测试（单个和组合）
- [ ] 搜索历史保存和清除测试
- [ ] 搜索建议准确性测试
- [ ] 高级搜索语法测试
- [ ] 性能测试（大量数据）
- [ ] 移动端响应式测试
- [ ] 无障碍功能测试

---

## 参考资源

- SQLite FTS5: https://www.sqlite.org/fts5.html
- Next.js Search: https://nextjs.org/docs/app/building-your-application/data-fetching/search-and-pagination
- Fuse.js (模糊搜索): https://fusejs.io/
- Pinyin Pro (拼音转换): https://pinyin-pro.cn/
- Search UI 组件库: https://github.com/okta/okta-search-ui

---

## 预计工作量

- 阶段一（基础筛选）：2-3 小时
- 阶段二（历史和建议）：2-3 小时
- 阶段三（高级搜索）：3-4 小时
- 阶段四（模糊搜索）：4-5 小时
- 阶段五（结果高亮）：1-2 小时

**总计**：12-17 小时

**建议实施顺序**：
1. 阶段一 → 阶段五 → 阶段二 → 阶段三 → 阶段四
2. 或先完成阶段一、二、五，满足基本需求
3. 阶段三、四可根据需求优先级调整
