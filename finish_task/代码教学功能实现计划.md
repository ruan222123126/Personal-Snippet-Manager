# 代码逐行解释教学功能 - 实现计划

## 一、需求概述

在代码片段管理系统中添加教学功能：
- 在编辑按钮旁边添加"教学"按钮
- 点击显示 Markdown 格式的代码逐行解释
- 解释内容可编辑

## 二、技术方案

### 2.1 数据存储

**使用现有的 `tutorial` 字段**（已在数据库中）存储 Markdown 格式的教学内容。

**Markdown 格式规范**：
```markdown
# 二叉树遍历教学

## 核心概念
深度优先搜索的三种方式...

## 逐行解释

### 第 1-2 行：函数定义
```python
def traverse(node):
    if not node: return
```
递归终止条件，处理空节点情况...

### 第 3 行：左子树遍历
```python
traverse(node.left)
```
先遍历左子树，采用深度优先策略...

## 时间复杂度
O(n) - 每个节点访问一次
```

**优势**：
- 灵活性高，不强制逐行对应
- 易于编写和维护
- 向后兼容，无需修改 schema

### 2.2 UI/UX 设计

**按钮位置**：
- 在 `SnippetActions.tsx` 中，编辑按钮和删除按钮之间添加教学按钮
- 有内容时：绿色正常按钮
- 无内容时：灰色"添加教学"按钮

**交互设计**：
- 卡片上的教学按钮 → 打开模态框（`TutorialModal.tsx`）快速预览
- 详情页底部 → 显示完整教学内容区域（`TutorialSection.tsx`）
- 编辑页面 → 添加"教学说明"标签页，使用 Markdown 编辑器

### 2.3 技术栈

| 功能 | 技术选择 | 理由 |
|------|---------|------|
| Markdown 渲染 | `react-markdown` + `remark-gfm` | 轻量、安全、可定制 |
| 代码高亮 | 复用现有 Shiki | 保持一致性 |
| 编辑器 | 自建 textarea + 实时预览 | 轻量级、可控 |
| 模态框 | 原生 + Tailwind CSS | 无需额外 UI 库 |

## 三、实现步骤

### 阶段 1：安装依赖（5 分钟）

```bash
npm install react-markdown remark-gfm
```

### 阶段 2：创建核心组件（2-3 小时）

**1. MarkdownRenderer.tsx**（Server Component）
- 路径：`components/ui/MarkdownRenderer.tsx`
- 功能：渲染 Markdown，集成 Shiki 代码高亮
- 自定义组件：h1/h2/h3, p, ul/ol, code（代码块）

**2. TutorialModal.tsx**（Client Component）
- 路径：`components/ui/TutorialModal.tsx`
- 功能：模态框显示教学内容
- 包含：编辑按钮（跳转到编辑页面）、关闭按钮
- 空状态：显示"暂无教学说明"提示

**3. TutorialSection.tsx**（Server Component）
- 路径：`components/ui/TutorialSection.tsx`
- 功能：详情页底部显示完整教学内容
- 包含：标题、编辑按钮、Markdown 渲染内容

**4. TutorialEditor.tsx**（Client Component）
- 路径：`components/ui/TutorialEditor.tsx`
- 功能：Markdown 编辑器，支持实时预览
- 特性：标签页切换（编辑/预览）、左右分屏

### 阶段 3：集成到现有组件（1-2 小时）

**1. 修改 SnippetActions.tsx**
- 路径：`components/SnippetActions.tsx`
- 修改内容：
  - 添加 `onTutorialClick` 和 `hasTutorial` props
  - 在编辑和删除按钮之间添加教学按钮
  - 使用 `BookOpenIcon`（Heroicons）

**2. 修改 SnippetCard.tsx**
- 路径：`components/SnippetCard.tsx`
- 修改内容：
  - 添加 `'use client'` 指令
  - 导入并使用 `useState` 管理模态框状态
  - 导入并渲染 `TutorialModal`
  - 传递 `onTutorialClick` 回调到 `SnippetActions`

**3. 修改 EditSnippetForm.tsx**
- 路径：`app/snippets/[id]/edit/EditSnippetForm.tsx`
- 修改内容：
  - 添加标签页状态（`activeTab: 'code' | 'tutorial'`）
  - 从 URL 查询参数判断是否打开教学标签页（`?tutorial=true`）
  - 添加 `tutorial` 字段到 `formData`
  - 添加标签页导航 UI
  - 在"教学说明"标签页中渲染 `TutorialEditor`

**4. 修改详情页 page.tsx**
- 路径：`app/snippets/[id]/page.tsx`
- 修改内容：
  - 导入 `TutorialSection`
  - 在代码块后面添加 `TutorialSection` 组件

### 阶段 4：修复 API（15 分钟）

**修改 app/api/snippets/[id]/route.ts**
- 路径：`app/api/snippets/[id]/route.ts`
- 修改位置：PUT 方法的 snippetData 构建部分（约 line 96-103）
- 修改内容：
  ```typescript
  if (description !== undefined) {
    snippetData.description = description;
  }
  if (tutorial !== undefined) {  // 添加此行
    snippetData.tutorial = tutorial;
  }
  ```

### 阶段 5：测试验证（1 小时）

**类型检查**：
```bash
npx tsc --noEmit
```

**功能测试**：
- [ ] 卡片上显示教学按钮
- [ ] 点击按钮打开模态框
- [ ] 模态框正确显示教学内容
- [ ] 模态框空状态正常显示
- [ ] 编辑按钮跳转到编辑页面
- [ ] 编辑页面显示"教学说明"标签页
- [ ] 编辑器实时预览正常工作
- [ ] 保存后教学内容更新
- [ ] 详情页底部显示教学内容
- [ ] Markdown 格式正确渲染（标题、列表、代码块）
- [ ] 代码块使用 Shiki 语法高亮
- [ ] 移动端响应式显示正常

## 四、关键文件清单

### 新建文件（4 个）
- `components/ui/MarkdownRenderer.tsx`
- `components/ui/TutorialModal.tsx`
- `components/ui/TutorialSection.tsx`
- `components/ui/TutorialEditor.tsx`

### 修改文件（5 个）
- `components/SnippetActions.tsx` - 添加教学按钮
- `components/SnippetCard.tsx` - 集成模态框状态管理
- `app/snippets/[id]/edit/EditSnippetForm.tsx` - 添加教学编辑标签页
- `app/snippets/[id]/page.tsx` - 添加教学区域显示
- `app/api/snippets/[id]/route.ts` - 修复 PUT 方法的 tutorial 处理

## 五、样式规范

**颜色方案**：
- 教学按钮：`text-green-600 dark:text-green-400`
- 编辑按钮：`text-blue-600 dark:text-blue-400`
- 删除按钮：`text-red-600 dark:text-red-400`

**间距和圆角**：
- 模态框：`rounded-xl`, `shadow-xl`, `max-w-4xl`
- 按钮间距：`gap-1`
- 内边距：`p-4` 或 `p-6`

**响应式设计**：
- 移动端：模态框全屏或接近全屏
- 桌面端：模态框居中，最大高度 85vh

## 六、注意事项

1. **Server Components 优先**：`MarkdownRenderer` 和 `TutorialSection` 使用 Server Components
2. **Client Components 必要性**：涉及交互（useState、事件处理）的组件才使用 Client Components
3. **类型安全**：确保所有组件都有完整的 TypeScript 类型定义
4. **向后兼容**：`tutorial` 字段为可选，现有代码片段不受影响
5. **安全性**：`react-markdown` 默认不渲染 HTML，防止 XSS 攻击

## 七、预期成果

完成后用户可以：
1. 在卡片上快速查看教学说明（模态框）
2. 在详情页深入学习完整教学内容
3. 在编辑页面使用 Markdown 编辑器编写逐行解释
4. 享受实时的编辑预览体验
5. 查看带语法高亮的代码示例（教学内容中的代码块）

## 八、未来扩展可能

- 行号高亮联动（点击解释中的代码引用，高亮对应代码行）
- 交互式代码演示（集成 CodeSandbox）
- 教学进度追踪（标记已学习的片段）
- AI 自动生成解释（集成 LLM API）
- 多人协作（评论和讨论功能）
