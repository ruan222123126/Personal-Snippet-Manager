å¤ªæ£’äº†ï¼ç¬¬ä¸€é˜¶æ®µçš„â€œéª¨æ¶ä¸è„Šæ¤â€å·²ç»æ­å»ºå¾—éå¸¸ç¨³å›ºã€‚ä½ å·²ç»å®Œæˆäº†æœ€è‰°éš¾çš„æ•°æ®åº“ Schema è®¾è®¡å’Œ FTS5 ç¯å¢ƒé…ç½®ã€‚

æ¥ä¸‹æ¥çš„**ç¬¬äºŒé˜¶æ®µ**ï¼Œæˆ‘ä»¬è¦ä¸ºè¿™ä¸ªç³»ç»Ÿæ³¨å…¥â€œçµé­‚â€å’Œâ€œå¤§è„‘â€ã€‚
**ç›®æ ‡**ï¼šå®ç° **æœåŠ¡ç«¯é«˜äº®é€»è¾‘** ä¸ **åç«¯æ ¸å¿ƒ API**ã€‚

è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼š

### ç¬¬äºŒé˜¶æ®µï¼šä¸šåŠ¡é€»è¾‘ä¸ API å®ç° (Service & API Layer)

#### 1. å®Œå–„é«˜äº®æœåŠ¡ (Shiki Service)

ä½ ç°åœ¨çš„ `lib/shiki.ts` åªæœ‰ä¸€ä¸ªå•ä¾‹ Getterï¼Œå®ƒè¿˜éœ€è¦ä¸€ä¸ªèƒ½ç›´æ¥æŠŠä»£ç å˜æˆ HTML çš„â€œåŠ å·¥å‡½æ•°â€ã€‚

* **åŠ¨ä½œ**ï¼šä¿®æ”¹ `lib/shiki.ts`ã€‚
* **ä»»åŠ¡**ï¼šåœ¨æ–‡ä»¶æœ«å°¾å¢åŠ å¹¶å¯¼å‡º `highlightCode` å‡½æ•°ã€‚
* **é€»è¾‘å‚è€ƒ**ï¼š
* æ¥æ”¶ `code` å’Œ `language` å‚æ•°ã€‚
* è°ƒç”¨ `getShikiHighlighter()` è·å–å®ä¾‹ã€‚
* ä½¿ç”¨ `highlighter.codeToHtml` æ–¹æ³•ï¼ŒæŒ‡å®š themesï¼ˆå»ºè®®åŒæ—¶é…ç½® light/darkï¼Œä»¥ä¾¿åç»­åšæ·±è‰²æ¨¡å¼é€‚é…ï¼‰ã€‚
* **å…³é”®ç‚¹**ï¼šå¢åŠ ä¸€ä¸ªå®¹é”™æœºåˆ¶ï¼Œå¦‚æœä¼ å…¥çš„è¯­è¨€ä¸æ”¯æŒï¼ˆæ¯”å¦‚ç”¨æˆ·éšä¾¿å†™äº†ä¸ª `xyz`ï¼‰ï¼Œé™çº§ä¸º `text` æˆ– `txt`ï¼Œé˜²æ­¢æœåŠ¡å™¨æŠ¥é”™å´©æºƒã€‚



#### 2. å®ç°æ ¸å¿ƒ API (The "Brain")

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿæœ€å¤æ‚çš„é€»è¾‘éƒ¨åˆ†ï¼Œéœ€è¦å¤„ç†â€œæ™®é€šæŸ¥è¯¢â€ã€â€œæ ‡ç­¾è¿‡æ»¤â€å’Œâ€œå…¨æ–‡æ£€ç´¢â€ä¸‰ç§æ¨¡å¼çš„åˆ‡æ¢ã€‚

* **åŠ¨ä½œ**ï¼šç¼–è¾‘ `app/api/snippets/route.ts`ã€‚
* **ä¾èµ–**ï¼šå¼•å…¥ `prisma` å•ä¾‹ã€‚
* **ä»»åŠ¡ A (GET æ–¹æ³• - æ··åˆæœç´¢)**ï¼š
1. è§£æ URL å‚æ•° (`q` å’Œ `tag`)ã€‚
2. **åˆ†æ”¯ 1 (æœç´¢æ¨¡å¼)**ï¼šå¦‚æœæœ‰ `q`ï¼Œä½¿ç”¨ `prisma.$queryRaw` æ‰§è¡ŒåŸç”Ÿ SQLã€‚
* *SQL é€»è¾‘*ï¼š`SELECT id FROM SnippetFTS WHERE SnippetFTS MATCH ${query} ORDER BY rank`ã€‚
* æ‹¿åˆ° ID åˆ—è¡¨åï¼Œå†ç”¨ `prisma.snippet.findMany`DD è·å–å®Œæ•´æ•°æ®ï¼ˆåŒ…å« tagsï¼‰ã€‚


3. **åˆ†æ”¯ 2 (æ ‡ç­¾æ¨¡å¼)**ï¼šå¦‚æœæœ‰ `tag`ï¼Œä½¿ç”¨ `prisma.snippet.findMany`ï¼Œé€šè¿‡ `tags: { some: { tag: { name: tag } } }` è¿‡æ»¤ã€‚
4. **åˆ†æ”¯ 3 (é»˜è®¤æ¨¡å¼)**ï¼šæŒ‰ `createdAt` å€’åºè¿”å›å‰ 20-50 æ¡ã€‚


* **ä»»åŠ¡ B (POST æ–¹æ³• - äº‹åŠ¡å†™å…¥)**ï¼š
1. æ¥æ”¶ JSONï¼š`{ title, code, language, tags }`ã€‚
2. ä½¿ç”¨ `prisma.$transaction` ä¿è¯åŸå­æ€§ã€‚
3. åœ¨åˆ›å»º Snippet æ—¶ï¼Œå¤„ç† `tags` å…³è”ã€‚
4. **å…³é”®æŠ€å·§**ï¼šå¯¹æ¯ä¸ª tag ä½¿ç”¨ `connectOrCreate`ã€‚å¦‚æœæ ‡ç­¾å­˜åœ¨å°±å…³è”ï¼Œä¸å­˜åœ¨å°±åˆ›å»ºã€‚è¿™èƒ½é¿å…æ ‡ç­¾é‡å¤ã€‚



#### 3. éªŒè¯ API (Headless Verification)

åœ¨å†™ UI ä¹‹å‰ï¼Œå¿…é¡»ç¡®ä¿ API æ˜¯é€šçš„ã€‚

* **åŠ¨ä½œ**ï¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æµ‹è¯•è„šæœ¬ `test-api.http` (å¦‚æœä½ ç”¨ VS Code REST Client) æˆ–è€…ç›´æ¥å‡†å¤‡ä¸¤æ¡ `curl` å‘½ä»¤ã€‚
* **æµ‹è¯•ç”¨ä¾‹ 1 (å†™å…¥)**ï¼šå‘é€ä¸€ä¸ª POST è¯·æ±‚ï¼ŒåŒ…å« `["React", "Next.js"]` è¿™æ ·çš„æ ‡ç­¾ï¼Œçœ‹çœ‹æ•°æ®åº“é‡Œæ˜¯å¦æ­£ç¡®ç”Ÿæˆäº† Snippet å’Œ Tagï¼Œä»¥åŠä¸­é—´è¡¨è®°å½•ã€‚
* **æµ‹è¯•ç”¨ä¾‹ 2 (æœç´¢)**ï¼šå‘é€ GET è¯·æ±‚ `?q=ä½ çš„å…³é”®è¯`ï¼Œç¡®è®¤ FTS æœç´¢èƒ½è¿”å›ç»“æœã€‚

---

### ğŸ’¡ ç»™ä½ çš„ä»£ç æç¤º (Code Snippets)

ä¸ºäº†è®©ä½ æ›´æµç•…åœ°å®Œæˆï¼Œè¿™é‡Œæä¾›é€‚é…ä½ å½“å‰é¡¹ç›®ç»“æ„çš„æ ¸å¿ƒä»£ç å—ã€‚

**1. `lib/shiki.ts` (è¿½åŠ éƒ¨åˆ†)**

```typescript
// ... existing code ...

export async function highlightCode(code: string, language: string) {
  const highlighter = await getShikiHighlighter();
  // ç®€å•å®¹é”™ï¼šå¦‚æœä¸æ”¯æŒè¯¥è¯­è¨€ï¼Œå›é€€åˆ° text
  const loadedCw = highlighter.getLoadedLanguages();
  const lang = loadedCw.includes(language) ? language : 'text';

  return highlighter.codeToHtml(code, {
    lang,
    themesbs: {
      light: 'github-light',
      dark: 'github-dark',
    },
  });
}

```

**2. `app/api/snippets/route.ts` (æ ¸å¿ƒç»“æ„)**

```typescript
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { Snippet } from '@prisma/client';

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const q = searchParams.get('q');
  const tag = searchParams.get('tag');

  try {
    let snippets: Snippet[] = [];

    if (q) {
      // 1. FTS å…¨æ–‡æœç´¢
      // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„ FTS è¯­æ³•è°ƒæ•´ï¼ŒPorter åˆ†è¯å™¨æœ‰æ—¶éœ€è¦ç»™å…³é”®è¯åŠ é€šé…ç¬¦
      // ç®€å•èµ·è§ï¼Œå…ˆç›´æ¥åŒ¹é…
      const rawIds = await prisma.$queryRaw<{ id: string }[]>`
        SELECT id FROM SnippetFTS 
        WHERE SnippetFTS MATCH ${q} 
        ORDER BY rank;
      `;
      
      const ids = rawIds.map((row) => row.id);
      
      if (ids.length > 0) {
        snippets = await prisma.snippet.findMany({
          where: { id: { in: ids } },
          include: { tags: { include: { tag: true } } },
        });
      }
    } else if (tag) {
      // 2. æ ‡ç­¾è¿‡æ»¤
      snippets = await prisma.snippet.findMany({
        where: {
          tags: { some: { tag: { name: tag } } }
        },
        orderBy: { createdAt: 'desc' },
        include: { tags: { include: { tag: true } } },
      });
    } else {
      // 3. é»˜è®¤åˆ—è¡¨
      snippets = await prisma.snippet.findMany({
        take: 20,
        orderBy: { createdAt: 'desc' },
        include: { tags: { include: { tag: true } } },
      });
    }

    return NextResponse.json(snippets);
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: 'Failed to fetch snippets' }, { status: 500 });
  }
}

export async function POST(request: Request) {
  try {
    const { title, code, language, description, tags } = await request.json(); // tags æ˜¯å­—ç¬¦ä¸²æ•°ç»„ ["React", "Hook"]

    // ä½¿ç”¨äº‹åŠ¡å¤„ç†å¤æ‚çš„å…³è”åˆ›å»º
    const result = await prisma.$transaction(async (tx) => {
      return await tx.snippet.create({
        data: {
          title,
          code,
          language,
          description,
          tags: {
            // å…³é”®é€»è¾‘ï¼šéå†æ ‡ç­¾æ•°ç»„ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå­˜åœ¨QKå…³è”
            create: tags.map((tagName: string) => ({
              tag: {
                connectOrCreate: {
                  where: { name: tagName },
                  create: { name: tagName },
                },
              },
            })),
          },
        },
        include: { tags: true },
      });
    });

    return NextResponse.json(result);
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: 'Failed to create snippet' }, { status: 500 });
  }
}

```

---

### âœ… éªŒæ”¶æ ‡å‡† (Definition of Done)

å®Œæˆæœ¬é˜¶æ®µåï¼Œä½ åº”è¯¥è¾¾åˆ°ï¼š

1. **POST API å¯ç”¨**ï¼šèƒ½é€šè¿‡å·¥å…·å‘æ•°æ®åº“å†™å…¥å¸¦æ ‡ç­¾çš„æ•°æ®ã€‚
2. **GET API å¯ç”¨**ï¼š
* ä¸å¸¦å‚æ•°èƒ½åˆ—å‡ºæ•°æ®ã€‚
* å¸¦ `?q=xx` èƒ½æœåˆ°åˆšæ‰å†™å…¥çš„å†…å®¹ï¼ˆæµ‹è¯• SQLite FTS æ˜¯å¦ç”Ÿæ•ˆï¼‰ã€‚


3. **é«˜äº®å‡½æ•°å°±ç»ª**ï¼š`lib/shiki.ts` æ— ç±»å‹æŠ¥é”™ï¼Œå‡†å¤‡å¥½è¢« UI ç»„ä»¶è°ƒç”¨ã€‚

