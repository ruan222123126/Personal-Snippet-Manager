# 任务：为代码卡片添加教学说明功能

**创建日期**: 2025-01-24
**优先级**: 中
**复杂度**: 中等

## 需求描述

为每个代码片段卡片添加一个"教学说明"(Tutorial)功能，允许用户编写详细的 Markdown 格式教学文档，帮助理解代码片段的使用方法、原理和实践。

## 功能需求

### 1. 数据库层
- **Schema 变更**: 在 `Snippet` 模型中添加 `tutorial` 字段
  - 类型: `String` (长文本，存储 Markdown 内容)
  - 可选: `true` (默认为 null)
  - 示例: `tutorial String?`

### 2. API 层
- **GET /api/snippets/[id]**: 返回 snippet 时包含 tutorial 字段
- **PUT /api/snippets/[id]**: 更新 snippet 时支持 tutorial 字段
- **POST /api/snippets**: 创建 snippet 时支持 tutorial 字段

### 3. UI 层

#### 3.1 卡片显示
- 在 `SnippetCard.tsx` 中添加"教学说明"按钮
- 按钮位置: 卡片底部操作区域
- 按钮图标: 📚 或书本图标
- 按钮文案: "教学说明" 或 "查看教学"
- 逻辑:
  - 如果 `tutorial` 为空/null: 按钮置灰或隐藏
  - 如果 `tutorial` 有内容: 点击显示教学内容

#### 3.2 教学内容展示
- 创建组件: `components/ui/TutorialView.tsx`
- **功能**:
  - 使用 `react-markdown` 或类似库渲染 Markdown
  - 支持 Markdown 语法: 标题、列表、代码块、链接等
  - 代码块使用与代码卡片相同的语法高亮
  - 响应式设计，适配移动端
- **交互**:
  - 对话框/模态框形式展示
  - 可关闭按钮
  - 可选: 支持全屏模式

#### 3.3 教学内容编辑
- 创建组件: `components/ui/TutorialEditor.tsx`
- **功能**:
  - Markdown 编辑器（带预览功能）
  - 实时预览
  - 工具栏: 加粗、斜体、代码块、列表等
  - 保存按钮
- **位置**:
  - 在详情页添加"编辑教学"按钮
  - 或在卡片上添加编辑按钮（仅作者可见）

### 4. 详情页增强
- 在 `app/snippets/[id]/page.tsx` 中显示教学内容
- 如果 `tutorial` 不为空，在代码片段下方展示
- 提供"编辑教学"按钮

## 技术实现建议

### Markdown 渲染库选择
推荐以下方案之一:

1. **react-markdown** (推荐)
   ```bash
   npm install react-markdown remark-gfm rehype-highlight
   ```
   - 轻量级，易用
   - 支持 GFM (GitHub Flavored Markdown)
   - 可配合现有 Shiki 高亮

2. **@uiw/react-md-editor** (编辑器方案)
   ```bash
   npm install @uiw/react-md-editor
   ```
   - 包含编辑和预览
   - 开箱即用的工具栏
   - 可能需要调整样式

3. **react-simplemde-editor** (简单编辑器)
   ```bash
   npm install react-simplemde-editor easymde
   ```
   - 基于 EasyMDE
   - 功能丰富

### 数据库迁移步骤
1. 编辑 `prisma/schema.prisma` 添加 `tutorial` 字段
2. 运行 `npx prisma migrate dev --name add_tutorial_to_snippet`
3. 运行 `npx prisma generate`

### 实现顺序
1. **Phase 1: 数据层** (1-2小时)
   - Schema 更新
   - 数据库迁移
   - API 更新

2. **Phase 2: 展示层** (2-3小时)
   - 创建 `TutorialView.tsx`
   - 集成到 `SnippetCard.tsx`
   - 集成到详情页

3. **Phase 3: 编辑层** (2-3小时)
   - 创建 `TutorialEditor.tsx`
   - 更新表单组件
   - 保存功能

4. **Phase 4: 优化** (1-2小时)
   - 样式优化
   - 移动端适配
   - 用户体验优化

## 验收标准

- [ ] 数据库迁移成功，`tutorial` 字段添加到 `Snippet` 表
- [ ] API 支持 tutorial 字段的读取和写入
- [ ] 卡片上显示"教学说明"按钮（仅当有内容时）
- [ ] 点击按钮弹出教学内容模态框
- [ ] Markdown 内容正确渲染（代码块高亮正常）
- [ ] 详情页显示教学内容
- [ ] 编辑功能可用，可保存 Markdown 内容
- [ ] TypeScript 类型检查通过 (`npx tsc --noEmit`)
- [ ] 移动端显示正常

## 预期效果

### 卡片示例
```
┌─────────────────────────────────┐
│  二叉树遍历          [查看教学]  │ ← 新按钮
├─────────────────────────────────┤
│  def traverse(node):            │
│      if not node: return        │
│      traverse(node.left)        │
│      visit(node)                │
│      traverse(node.right)       │
├─────────────────────────────────┤
│  #Python #Tree #DFS            │
│  📚 教学说明  ✏️ 编辑           │ ← 底部操作栏
└─────────────────────────────────┘
```

### 教学内容示例
```markdown
# 二叉树遍历教学

## 前置知识
- 理解树的基本概念
- 递归函数的理解

## 算法思路
深度优先搜索(DFS)有三种遍历方式：
1. 前序遍历：根 → 左 → 右
2. 中序遍历：左 → 根 → 右
3. 后序遍历：左 → 右 → 根

## 代码详解
\`\`\`python
def traverse(node):
    if not node:  # 递归终止条件
        return
    traverse(node.left)   # 先遍历左子树
    visit(node)           # 访问当前节点
    traverse(node.right)  # 再遍历右子树
\`\`\`

## 练习题
1. 实现前序遍历
2. 实现后序遍历
```

## 注意事项

1. **性能考虑**: tutorial 字段可能存储大量文本，考虑:
   - 是否需要分页加载
   - 是否需要缓存机制

2. **安全考虑**:
   - Markdown 渲染需要防止 XSS
   - 使用 `rehype-sanitize` 清理 HTML

3. **用户体验**:
   - 如果 tutorial 很长，提供目录导航
   - 考虑添加"收起/展开"功能

4. **兼容性**:
   - 确保现有的 snippet 不受影响（tutorial 默认为 null）
   - API 向后兼容

## 参考资源

- [react-markdown 文档](https://github.com/remarkjs/react-markdown)
- [Prisma Schema 文档](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference)
- [Next.js App Router 文档](https://nextjs.org/docs/app)

---

**准备开始**: 确认方案无误后，按照"实现顺序"依次完成各个阶段。
